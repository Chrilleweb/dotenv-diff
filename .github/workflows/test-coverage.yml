name: Tests & Coverage

on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Install diff-cover
        run: pip install diff-cover

      - name: Run coverage (PR branch)
        run: pnpm run coverage

      - name: Save PR coverage summary
        run: |
          cp coverage/coverage-summary.json pr-coverage-summary.json

      - name: Run coverage (main branch)
        run: |
          git stash --include-untracked || true
          git fetch origin main
          git checkout origin/main
          pnpm install --frozen-lockfile --silent
          pnpm run coverage || true
          cp coverage/coverage-summary.json main-coverage-summary.json || echo '{"total":{"lines":{"pct":0}}}' > main-coverage-summary.json
          git checkout ${{ github.event.pull_request.head.sha }}
          git stash pop || true
          pnpm install --frozen-lockfile --silent

      - name: Fix lcov paths
        run: |
          if [ -f "coverage/lcov.info" ]; then
            sed -i "s|SF:$(pwd)/||g" coverage/lcov.info
          fi

      - name: Run diff-cover analysis
        id: diff_cover
        run: |
          echo "## ğŸ“Š Unit Test Coverage" > comment.md
          echo "" >> comment.md

          COVERAGE_THRESHOLD=80
          all_passed=true

          # Overall coverage for PR branch
          overall_coverage="N/A"
          if [ -f "pr-coverage-summary.json" ]; then
            overall_coverage=$(jq -r '.total.lines.pct' "pr-coverage-summary.json")
          fi

          # Overall coverage for main branch
          main_coverage="N/A"
          if [ -f "main-coverage-summary.json" ]; then
            main_coverage=$(jq -r '.total.lines.pct' "main-coverage-summary.json")
          fi

          # Compute delta
          if [ "$overall_coverage" != "N/A" ] && [ "$main_coverage" != "N/A" ]; then
            delta=$(echo "$overall_coverage $main_coverage" | awk '{
              diff = $1 - $2
              if (diff > 0) printf "+%.2f", diff
              else printf "%.2f", diff
            }')

            # Pick emoji based on direction
            delta_num=$(echo "$overall_coverage $main_coverage" | awk '{print $1 - $2}')
            delta_emoji=$(echo "$delta_num" | awk '{
              if ($1 > 0) print "ğŸ“ˆ"
              else if ($1 < 0) print "ğŸ“‰"
              else print "â¡ï¸"
            }')

            echo "**Overall coverage**: ${overall_coverage}% ${delta_emoji} ${delta}% vs \`main\` (${main_coverage}%)" >> comment.md
          else
            echo "**Overall coverage**: ${overall_coverage}%" >> comment.md
          fi

          echo "" >> comment.md

          diff-cover coverage/lcov.info \
            --compare-branch=origin/${{ github.event.pull_request.base.ref }} \
            --diff-range-notation=... \
            --json-report diff-coverage.json \
            --fail-under=0 || true

          if [ -f "diff-coverage.json" ]; then
            total_lines=$(jq -r '.total_num_lines' diff-coverage.json)

            if [ "$total_lines" != "0" ] && [ "$total_lines" != "null" ]; then
              percent=$(jq -r '.total_percent_covered' diff-coverage.json)
              violations=$(jq -r '.total_num_violations' diff-coverage.json)
              covered=$((total_lines - violations))

              if [ "$percent" -lt "$COVERAGE_THRESHOLD" ]; then
                all_passed=false
              fi

              if [ "$percent" = "100" ]; then
                emoji="âœ…"
                status="PASS"
              elif [ "$percent" -ge "$COVERAGE_THRESHOLD" ]; then
                emoji="âš ï¸"
                status="PASS"
              else
                emoji="âŒ"
                status="FAIL"
              fi

              echo "**Diff coverage**: $emoji ${percent}% (${covered}/${total_lines} lines) - $status" >> comment.md
              echo "" >> comment.md

              if [ "$violations" != "0" ]; then
                echo "<details>" >> comment.md
                echo "<summary>ğŸ” Uncovered lines in diff</summary>" >> comment.md
                echo "" >> comment.md
                echo '```' >> comment.md
                jq -r '.src_stats | to_entries[] | .key as $file | .value.violation_lines[] | "\($file):\(.)"' diff-coverage.json >> comment.md
                echo '```' >> comment.md
                echo "" >> comment.md
                echo "</details>" >> comment.md
              fi
            else
              echo "âœ¨ No new testable lines in this PR" >> comment.md
            fi
          fi

          echo "---" >> comment.md
          echo "" >> comment.md
          if [ "$all_passed" = true ]; then
            echo "âœ… **Coverage threshold met** (â‰¥${COVERAGE_THRESHOLD}%)" >> comment.md
          else
            echo "âŒ **Coverage threshold not met** (required: â‰¥${COVERAGE_THRESHOLD}%)" >> comment.md
          fi

          echo "all_passed=$all_passed" >> $GITHUB_OUTPUT

      - name: Comment PR with coverage
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: comment.md

      - name: Fail if coverage is below threshold
        if: steps.diff_cover.outputs.all_passed == 'false'
        run: |
          echo "âŒ Coverage check failed: Coverage below 80%"
          exit 1